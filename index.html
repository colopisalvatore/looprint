<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="color-scheme" content="dark">
    <title>Looprint (Beta)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="styles.css">

</head>
<body>
<div class="container">
    <div class="header-row">
        <div style="flex: 1; display: flex; align-items: center; gap: 16px;">
            <img src="logo.png" alt="Looprint Logo" class="header-logo">
            <div style="flex: 1;">
                <h1 data-lang="title">Looprint (Beta)</h1>
                <p class="subtitle" data-lang="subtitle">
                    Automated multi-loop G-code builder for Bambu Lab P1/P1S, X1/X1C, A1, and A1 Mini. Supports G-code and 3MF files.
                </p>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
            <div class="language-selector">
                <div id="google_translate_element"></div>
            </div>
            <button class="instructions-btn" onclick="openInstructions()" title="View instructions">
                üìñ Instructions
            </button>
        </div>
    </div>
    
    <!-- Quick Start Guide -->
    <div class="quick-start-box" style="margin-bottom: 24px;">
        <h3 style="margin-top: 0;">üöÄ Quick Start</h3>
        <p style="margin-bottom: 16px;">Get started in 3 simple steps:</p>
        <div class="quick-start-steps">
            <div class="quick-start-step">
                <strong>1. Upload File</strong>
                <span style="font-size: 0.9rem;">Upload your sliced G-code or 3MF file</span>
            </div>
            <div class="quick-start-step">
                <strong>2. Configure</strong>
                <span style="font-size: 0.9rem;">Set number of loops and confirm safety settings</span>
            </div>
            <div class="quick-start-step">
                <strong>3. Generate</strong>
                <span style="font-size: 0.9rem;">Click "Generate Loop File" and download</span>
            </div>
        </div>
        <p style="margin-top: 16px; margin-bottom: 0; font-size: 0.9rem; color: var(--muted);">
            <strong>‚ö†Ô∏è Beta Notice:</strong> Looprint is still in beta. Not all features have been tested on hardware. Do not leave your printer unattended ‚Äî always stay nearby and monitor the process during automated looping.
        </p>
    </div>

    <div class="section" style="background: var(--input); padding: 16px; border-radius: 10px; border-left: 4px solid var(--accent);"> 
        <p class="help-text" style="margin: 0; font-size: 0.9rem;" id="factorianLinkFooter">
            <strong>üí° Based on <a href="https://factoriandesigns.com/" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none;">Factorian Designs</a> G-code templates.</strong> I recommend watching his video: <a href="https://factoriandesigns.com/print-automation-bambu-lab-a1-a1-mini" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none;">A1/A1 Mini</a> or <a href="https://factoriandesigns.com/print-automation-bambu-lab-p1-x1-2" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none;">P1/P1S/X1/X1C</a>.
        </p>
    </div>

    <!-- Export Instructions from Bambu Studio -->
    <div class="section">
        <div class="section-title">üì§ How to Export from Bambu Studio</div>
        <p class="help-text" style="margin-bottom: 16px;">Follow these steps to export your file from Bambu Studio:</p>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
            <!-- G-code Export -->
            <div style="background: var(--input); border: 2px solid var(--border); border-radius: 10px; padding: 20px; border-left: 4px solid var(--accent);">
                <h4 style="margin: 0 0 12px 0; color: var(--accent); font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    üìÑ G-code Files
                </h4>
                <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                    <li style="margin-bottom: 8px;">Slice your model in Bambu Studio (any G-code file works - Looprint adds start and end code automatically)</li>
                    <li style="margin-bottom: 8px;">Click <strong>"File"</strong> in the menu bar</li>
                    <li style="margin-bottom: 8px;">Select <strong>"Export"</strong> ‚Üí <strong>"Export G-Code"</strong></li>
                    <li style="margin-bottom: 0;">Upload the exported G-code file to Looprint</li>
                </ol>
                <p style="margin-top: 12px; margin-bottom: 0; font-size: 0.85rem; color: var(--muted); padding: 10px; background: var(--card); border-radius: 6px;">
                    <strong>Note:</strong> G-code files must be printed from SD card (required). Looprint automatically adds start and end code to all files. <strong>Optional:</strong> You can use <a href="https://factoriandesigns.com/" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none;">Factorian Designs</a> start and end code templates if you prefer. I recommend watching his video: <a href="https://factoriandesigns.com/print-automation-bambu-lab-a1-a1-mini" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none;">A1/A1 Mini</a> or <a href="https://factoriandesigns.com/print-automation-bambu-lab-p1-x1-2" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none;">P1/P1S/X1/X1C</a>.
                </p>
            </div>
            
            <!-- 3MF Export -->
            <div style="background: var(--input); border: 2px solid var(--border); border-radius: 10px; padding: 20px; border-left: 4px solid var(--accent);">
                <h4 style="margin: 0 0 12px 0; color: var(--accent); font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    üì¶ 3MF Files
                </h4>
                <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                    <li style="margin-bottom: 8px;">Slice your model in Bambu Studio</li>
                    <li style="margin-bottom: 8px;">Click the <strong>dropdown</strong> where you normally click "Print Plate"</li>
                    <li style="margin-bottom: 8px;">Select <strong>"Export plate sliced file"</strong></li>
                    <li style="margin-bottom: 0;">Upload the exported 3MF file to Looprint</li>
                </ol>
                <p style="margin-top: 12px; margin-bottom: 0; font-size: 0.85rem; color: var(--muted); padding: 10px; background: var(--card); border-radius: 6px;">
                    <strong>Note:</strong> 3MF files can be sent directly to printer from Bambu Studio after generating
                </p>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title" data-lang="step1Title">üìÅ 1. Upload File</div>
        <div class="file-upload-area" id="fileUploadArea">
            <input type="file" id="fileInput" accept=".gcode,.gco,.g,.txt,.3mf" onchange="validateFileImmediate()" style="display: none;">
            <label for="fileInput" style="display: inline-block; padding: 12px 24px; background: var(--accent); color: #06090f; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 10px; transition: all 0.2s; box-shadow: 0 2px 4px rgba(46, 160, 67, 0.3);">
                üìÅ Browse Files
            </label>
            <p style="margin: 10px 0 0; font-size: 0.9rem; color: var(--muted);">or drag and drop your G-code or 3MF file here</p>
        </div>
        <p id="fileSizeEstimate" class="file-size-estimate" style="display:none;"></p>
        <p id="fileValidationStatus" style="display:none; font-size:0.85rem; margin-top:12px; font-weight:600;"></p>
    </div>

    <div class="section">
        <div class="section-title" data-lang="step2Title">‚öôÔ∏è 2. Loop Configuration</div>
        <div class="row">
            <div class="col">
                <label for="loopCount" data-lang="loopsLabel">Number of loops</label>
                <input type="number" id="loopCount" value="5" min="1" step="1" onchange="saveSettings()">
            </div>
            <div class="col">
                <label for="printerModel">Printer Model</label>
                <select id="printerModel" onchange="handlePrinterModelChange()">
                    <option value="">Select printer model...</option>
                    <option value="P1">P1 / P1S</option>
                    <option value="A1">A1</option>
                    <option value="A1Mini">A1 Mini</option>
                    <option value="x1">X1 / X1C</option>
                </select>
                <small id="autoDetectedPrinterNote" style="display: none; color: var(--accent); margin-top: 6px; font-size: 0.75rem; font-weight: 600;">
                    ‚úì Auto-detected from 3MF file and locked
                </small>
            </div>
        </div>
        <div class="row" style="margin-top: 16px;">
            <div class="col">
                <label for="speedMode">Speed Mode</label>
                <select id="speedMode" class="input-field" onchange="saveSettings()">
                    <option value="100" selected>Standard (100%)</option>
                    <option value="124">Sport (124%)</option>
                    <option value="166">Ludicrous (166%)</option>
                </select>
                <p class="help-text" style="margin-top: 4px; margin-bottom: 0; font-size: 0.75rem; color: var(--muted);">Sets the print speed for each loop.</p>
            </div>
        </div>

        <div style="background: var(--input); padding: 16px; border-radius: 10px; border-left: 4px solid var(--accent); margin-top: 16px;">
            <div class="checkbox-container">
                <input type="checkbox" id="skirtConfirmed">
                <label for="skirtConfirmed">
                    <span data-lang="safetyText" style="font-weight: 600;">I confirm this file was sliced with Brim enabled.</span>
                </label>
            </div>
            <p class="help-text" style="margin-top: 8px; margin-left: 28px; margin-bottom: 0; font-size: 0.85rem; color: var(--muted);">
                This replaces the standard purge line behavior, ensuring a clean and consistent first layer.
            </p>
        </div>
        
        <div class="checkbox-container" id="purgeContainer" style="display: none; margin-top: 16px;">
            <input type="checkbox" id="purgeEnabled" checked>
            <label for="purgeEnabled">
                <span>Enable Start Line Purge (P1/P1S/X1/X1C)</span>
            </label>
            <p class="help-text" style="margin-top: 4px; margin-left: 28px; font-size: 0.85rem; color: var(--muted);">
                Filament flush sequence in start code (extrudes 50mm at 250¬∞C to clean nozzle). Useful when switching materials or after pause. Default: Enabled. Disable for faster start when using same filament.
            </p>
        </div>
        
        <div class="advanced-toggle-container" style="margin-top: 16px;">
            <label for="showAdvancedSettings">
                <input type="checkbox" id="showAdvancedSettings" onchange="toggleAdvancedSettings()">
                <span style="font-weight: 600;">‚öôÔ∏è Show Advanced Settings (Push-off Configuration)</span>
            </label>
        </div>
    </div>

    <div class="bed-preview-wrapper">
        <div class="bed-preview" id="bedPreviewContainer">
            <!-- P1/P1S/X1/X1C Mode: CSS-based zones -->
            <div class="bed-preview-p1" id="bedPreviewP1">
                <div class="bed-label bed-label-front" data-lang="bedPreviewFront">FRONT</div>
                <div class="bed-label bed-label-back" data-lang="bedPreviewBack">BACK</div>
                <div class="bed-label bed-label-left" data-lang="bedPreviewLeft">LEFT</div>
                <div class="bed-label bed-label-right" data-lang="bedPreviewRight">RIGHT</div>
                <div class="bed-zone center" id="zone-center" onclick="selectDirection('center')"><span data-lang="bedZoneCenter">Center</span></div>
                <div class="bed-zone right" id="zone-right" onclick="selectDirection('right')"><span data-lang="bedZoneRight">Right</span></div>
                <div class="bed-zone left" id="zone-left" onclick="selectDirection('left')"><span data-lang="bedZoneLeft">Left</span></div>
            </div>
            <!-- A1 Mode: Canvas-based visualization -->
            <canvas id="bedPreviewCanvas" class="bed-preview-canvas" style="display: none;"></canvas>
        </div>
        <div class="bed-preview-text">
            <strong data-lang="bedPreviewTitle">Bed Preview & Model Placement</strong>
            <p class="help-text" id="bedPreviewModeText" data-lang="bedPreviewText">
                The zone with the <strong style="color: var(--accent);">green border</strong> is the selected push direction.
                <br><span style="font-size: 0.85em;">In advanced mode, you can click any zone to change it after file upload.</span>
            </p>
            <p class="bed-offset-line">
                <span data-lang="bedPreviewOffsetLabel">Z push offset:</span>
                <strong><span id="bedOffsetDisplay">30</span> mm</strong>
                <span data-lang="bedPreviewOffsetSuffix">below top of print</span>
            </p>
            <p id="sweepIndicator" class="bed-offset-line" style="display: none; color: var(--accent); margin-top: 8px;">
                <span style="font-weight: 600;">üßπ Full Bed Sweep:</span>
                <strong><span id="sweepStatusText">Enabled</span></strong>
                <span id="sweepModeText" style="font-size: 0.85em; color: var(--muted);">(7 passes after each loop)</span>
            </p>
            <p class="offset-warning" data-lang="zOffsetWarning">‚ö†Ô∏è Advanced: Incorrect values can cause collisions.</p>
            <div id="directionWarning" class="direction-warning" style="display: none;">
                ‚ö†Ô∏è <strong>Warning:</strong> You have changed the push direction from the automatically detected direction. Make sure this matches your model placement.
            </div>
            <div id="directionInfo" class="direction-info" style="display: none;">
                ‚ÑπÔ∏è <strong>Auto-detected:</strong> Push direction was automatically set based on model placement.
            </div>
        </div>
    </div>

    <div class="btn-row" style="margin-top: 24px; margin-bottom: 24px; gap: 12px; flex-wrap: wrap;">
        <button class="primary" id="generateBtn" onclick="processFiles()" data-lang="generateBtn" style="flex: 1; min-width: 200px;">
            ‚ú® Generate Loop File
        </button>
        <button class="secondary" id="generateTestBtn" onclick="showTestFileInfo()" data-lang="generateTestBtn" style="display:none;" title="Generate a test file with only push-off sequence for testing">
            üß™ Generate Test File
        </button>
        <button class="secondary" id="generateSweepTestBtn" onclick="generateSweepTestFile()" style="display:none;" title="Generate a test file with only sweep sequence for testing">
            üßπ Generate Sweep Test File
        </button>
        <button class="secondary" onclick="resetDefaults()" data-lang="resetBtn">
            üîÑ Reset to Defaults
        </button>
    </div>

    <p id="statusMessage"></p>

    <div class="section" id="endCodeSection">
        <div class="section-title" data-lang="endSectionTitle">üîß 3. Push-off Configuration (Advanced)</div>
        <p class="help-text" data-lang="endSectionHelp">
            Push direction is automatically detected from your file. <strong>You can click the zones in the bed preview above to change it manually.</strong>
            <br><span style="font-size: 0.85em; color: var(--muted);">Note: In simple mode, push direction is locked to the auto-detected value. In advanced mode, you can change it but will see a warning if it differs from the auto-detected direction.</span>
        </p>
        
        
        <div class="row" style="margin-top: 15px;">
            <div class="col">
                <label for="cooldownTempInput" data-lang="cooldownTempLabel">Target Bed Temp (¬∞C)</label>
                <input type="number" id="cooldownTempInput" value="18" min="15" max="90" step="1" oninput="saveSettings(); checkCooldownWarning(); updateEndCodeTextareas();">
                <p id="cooldownWarningMessage" style="color:var(--danger); margin-top: 5px; font-size: 0.75rem; display: none; font-weight: 600;"></p>
                <p class="help-text" data-lang="cooldownHelp">Default 18¬∞C (Approx. 23¬∞C on the plate). Wait max 60 min.</p>
            </div>
            
            <div class="col">
                <label for="zOffsetInput" data-lang="zOffsetLabel">Z Push Offset (mm)</label>
                <input type="number" id="zOffsetInput" value="30" min="5" max="120" step="1" oninput="saveSettings(); applyOffset();">
                <p id="zOffsetStatus" style="font-size: 0.75rem; margin-top: 4px; display: none; font-weight: 600;"></p>
                <p class="help-text" data-lang="zOffsetHelp">Default 30mm below top (P1/X1). A1 Factorian logic uses 40mm in the automated calculation.</p>
            </div>
        </div>
        
        <div class="row" style="margin-top: 15px;">
            <div class="col">
                <label for="pushLaneOffsetInput">Push Lane Offset (mm)</label>
                <input type="number" id="pushLaneOffsetInput" value="30" min="10" max="60" step="1" oninput="saveSettings(); updatePushLaneOffset();">
                <p id="pushLaneOffsetStatus" style="font-size: 0.75rem; margin-top: 4px; display: none; font-weight: 600;"></p>
                <p id="pushLaneOffsetMaxInfo" style="font-size: 0.75rem; margin-top: 4px; display: none; color: var(--muted);"></p>
                <p class="help-text">Distance from model center for left/right push lanes. Default 30mm. Auto-adjusted if too large for model placement.</p>
            </div>
            <div class="col">
                <label for="pushSpeedInput">Push-off Speed (mm/min)</label>
                <input type="number" id="pushSpeedInput" value="300" min="100" max="1000" step="50" oninput="saveSettings(); updateEndCodeTextareas();">
                <p class="help-text">Speed of the push-off motion. Default 300mm/min. Lower = slower, safer for delicate prints.</p>
            </div>
        </div>

        <div class="setting-block" style="margin-top: 20px;">
            <div class="checkbox-container">
                <input type="checkbox" id="enableSweep" onchange="saveSettings(); toggleSweepSettings(); updateEndCodeTextareas();">
                <label for="enableSweep">
                    <span>Enable Full Bed Sweep</span>
                </label>
            </div>
            <p class="help-text" style="margin-top: 5px; margin-left: 24px;">Sweeps entire bed in 7 passes (safe one-way back-to-front pattern) after push-off to clear any debris. Returns in straight line before shifting to next pass. Default Z: 1mm (bed level), adjustable.</p>
            
            <div id="sweepSettings" style="margin-top: 15px; margin-left: 24px; display: none;">
                <div class="row" style="margin-top: 10px;">
                    <div class="col">
                        <label for="sweepSpeedInput">Sweep Speed (mm/min)</label>
                        <input type="number" id="sweepSpeedInput" value="300" min="100" max="1000" step="50" oninput="saveSettings(); updateEndCodeTextareas();">
                        <p class="help-text">Speed of the sweep motion. Default 300mm/min. Always runs 7 passes with automatic spacing.</p>
                    </div>
                    <div class="col">
                        <label for="sweepZInput">Sweep Z Height (mm)</label>
                        <input type="number" id="sweepZInput" value="1" min="0.5" max="50" step="0.5" oninput="saveSettings(); updateEndCodeTextareas();">
                        <p class="help-text">Z height for sweep (distance above bed). Default 1mm (bed level). Lower = closer to bed.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="setting-block" id="a1NegativeZContainer" style="margin-top: 20px; display: none;">
            <div class="checkbox-container">
                <input type="checkbox" id="enableA1NegativeZ" onchange="saveSettings(); updateEndCodeTextareas();">
                <label for="enableA1NegativeZ">
                    <span>Enable Negative Z Push-Off</span>
                </label>
            </div>
            <div style="margin-top: 10px; margin-left: 24px; padding: 10px; background: rgba(248, 81, 73, 0.1); border: 1px solid rgba(248, 81, 73, 0.3); border-radius: 6px;">
                <p style="margin: 0 0 8px 0; font-size: 0.78rem; color: var(--danger); font-weight: 600; line-height: 1.5;">
                    ‚ö†Ô∏è <strong>WARNING:</strong> This feature uses negative Z values (Z-17) when nozzle head is at X-48 (far left). Only use if you do NOT have a Z-axis stiffener mod installed.
                </p>
                <p style="margin: 0; font-size: 0.75rem; color: var(--muted); line-height: 1.5;">
                    Based on Factorian Designs custom end code logic. Use with caution!
                </p>
            </div>
            <p class="help-text" style="margin-top: 10px; margin-left: 24px; line-height: 1.5;">
                Adds an additional push-off sequence after standard push-off, using negative Z for low-height models. This is an advanced feature and should only be used when standard push-off is insufficient for very low parts.
            </p>
        </div>
        <div id="block-start" class="code-section" style="margin-top: 20px;">
            <div class="code-header">
                <div class="code-title">Start G-code</div>
                <p class="code-desc">Start code that will be inserted at the beginning of each loop. Variables are replaced with values from your file.</p>
            </div>
            <div class="code-actions"><button type="button" class="btn-pill" onclick="copyCode('startCode')" data-lang="copyBtn">Copy G-code</button></div>
            <textarea id="startCode" class="code-textarea" readonly></textarea>
        </div>

        <div class="push-selector-label" style="margin-top: 20px;">
            <span>üìç</span><span data-lang="selectDirectionLabel">Selected Push Direction:</span>
        </div>
        <div class="push-selector">
            <div class="push-option" id="opt-left" data-lang="optLeft">Left</div>
            <div class="push-option active" id="opt-center" data-lang="optCenter">Center</div>
            <div class="push-option" id="opt-right" data-lang="optRight">Right</div>
        </div>

        <div id="block-left" class="code-section disabled">
            <div class="code-header">
                <div class="code-title" data-lang="endLeftTitle">Left Push End G-code</div>
                <p class="code-desc" data-lang="endLeftDesc">Pushes model from left zone towards front. Z height calculated automatically.</p>
            </div>
            <div class="code-actions"><button type="button" class="btn-pill" onclick="copyCode('endLeftCode')" data-lang="copyBtn">Copy G-code</button></div>
            <textarea id="endLeftCode" class="code-textarea" readonly></textarea>
        </div>

        <div id="block-center" class="code-section active">
            <div class="code-header">
                <div class="code-title" data-lang="endCenterTitle">Center Push End G-code</div>
                <p class="code-desc" data-lang="endCenterDesc">Pushes model from center zone towards front. Z height calculated automatically.</p>
            </div>
            <div class="code-actions"><button type="button" class="btn-pill" onclick="copyCode('endCenterCode')" data-lang="copyBtn">Copy G-code</button></div>
            <textarea id="endCenterCode" class="code-textarea" readonly></textarea>
        </div>
        
        <div id="block-right" class="code-section disabled">
            <div class="code-header">
                <div class="code-title" data-lang="endRightTitle">Right Push End G-code</div>
                <p class="code-desc" data-lang="endRightDesc">Pushes model from right zone towards front. Z height calculated automatically.</p>
            </div>
            <div class="code-actions"><button type="button" class="btn-pill" onclick="copyCode('endRightCode')" data-lang="copyBtn">Copy G-code</button></div>
            <textarea id="endRightCode" class="code-textarea" readonly></textarea>
        </div>
        
        <!-- A1 / A1 Mini End G-code Section (shown only when A1 or A1Mini is selected) -->
        <div id="block-a1" class="code-section" style="display: none; margin-top: 20px;">
            <div class="code-header">
                <div class="code-title">A1 / A1 Mini End G-code</div>
                <p class="code-desc">A1/A1 Mini-specific end code with Y-axis push-off and wiggle sweep. Z height calculated automatically using Factorian's 41mm rule.</p>
            </div>
            <div class="code-actions"><button type="button" class="btn-pill" onclick="copyCode('endA1Code')" data-lang="copyBtn">Copy G-code</button></div>
            <textarea id="endA1Code" class="code-textarea" readonly></textarea>
        </div>

    </div>
    
    <div id="loadingContainer" class="loading-container">
        <div class="progress-bar-container">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <p id="progressText" class="progress-text">Processing...</p>
    </div>

    <div id="output" class="output-area">
        <div class="output-header">
            <div class="output-header-icon">‚úÖ</div>
            <strong data-lang="outputReady">Loop File Ready</strong>
        </div>
        <p data-lang="outputDesc">Your file has been looped into a single file with push-off sequences between each loop.</p>
        <p class="stat-line"><span data-lang="statLabelSource">Source file:</span> <span class="value" id="statSourceName">‚Äì</span></p>
        <p class="stat-line"><span data-lang="statLabelLoops">Total loops:</span> <span class="value" id="statLoops">0</span></p>
        <p class="stat-line" id="pushDirectionStatLine" style="display:none;">
            <span data-lang="statLabelPushDirection">Push direction:</span> 
            <span class="value" id="statPushDirection">‚Äì</span>
        </p>
        <p class="stat-line" id="filamentStatLine" style="display:none;">
            <span data-lang="statLabelFilament">Est. Filament usage:</span> 
            <span class="value" id="statFilament">0</span> <span class="value" id="statFilamentUnit">g</span>
        </p>
        <p class="stat-line" id="timeStatLine" style="display:none;">
            <span data-lang="statLabelTime">Est. Total Print Time:</span> 
            <span class="value" id="statTime">0</span>
            <span style="font-size: 0.75rem; color: var(--muted); margin-left: 6px;" data-lang="timeCooldownNote">(estimate calculated with 60min cooldown per loop)</span>
        </p>
        <p class="stat-line" id="fileSizeStatLine" style="display:none;">
            <span data-lang="statLabelFileSize">Est. File size:</span> 
            <span class="value" id="statFileSize">0</span>
        </p>
        <p class="stat-line" id="bedTempStatLine" style="display:none;">
            <span data-lang="statLabelBedTemp">Target Bed Temp:</span> 
            <span class="value" id="statBedTemp">‚Äì</span>
        </p>
        <p class="stat-line" id="pushOffsetStatLine" style="display:none;">
            <span data-lang="statLabelPushOffset">Z Push Offset:</span> 
            <span class="value" id="statPushOffset">‚Äì</span>
        </p>

        <div class="output-actions">
            <button class="primary" style="font-size:0.9rem; padding-inline:18px;" onclick="downloadFile()" id="downloadBtn" data-lang="downloadBtn">Download Looped File</button>
        </div>
    </div>

    <div class="donation-container">
        <div style="text-align: center; margin-bottom: 12px;">
            <img src="logo.png" alt="Looprint Logo" style="height: 60px; width: auto; display: block; margin: 0 auto;">
        </div>
        <p class="help-text" style="margin-bottom: 8px; text-align: center;">Find this tool useful? Support the project and keep Looprint updated:</p>
        <div style="text-align: center;">
            <a href="https://buymeacoffee.com/nickiandersen" target="_blank" rel="noopener noreferrer" class="donate-btn">
                ‚òï Buy me a coffee
            </a>
        </div>
    </div>

    <div class="footer">
        <div class="footer-text" data-lang="footerText" style="display: none;">
            <strong>‚ö†Ô∏è Safety reminder:</strong> Always test with a simple model first. Print from SD card.
        </div>
        <div class="footer-note" data-lang="footerNote" id="factorianLinkFooterNote">
            Looprint loops your file and adds push-off sequences between loops. All print settings (temperatures, speeds, etc.) come from your original file. Start and end code are added automatically for all file types (G-code and 3MF).
        </div>
        <p style="width: 100%; text-align: center; font-size: 0.8rem; color: var(--muted); margin: 8px 0 4px 0;">
            Total loops automated by community: <span id="global-counter" style="color: var(--accent); font-weight: 600;">...</span>
        </p>
        <p style="width: 100%; text-align: right; font-size: 0.75rem; color: var(--text); margin: 0; padding: 5px 0 0; font-weight: 600;">Nicki Andersen</p>
        <p style="width: 100%; text-align: right; font-size: 0.75rem; color: var(--muted); margin: 0; padding: 2px 0 0;">(v3.0 Beta)</p>
    </div>
</div>

    <!-- Instructions Modal -->
    <div id="instructionsModal" class="instructions-modal" onclick="closeInstructionsOnBackdrop(event)">
        <div class="instructions-content" onclick="event.stopPropagation()">
            <div class="instructions-header">
                <h2>üìñ Looprint Instructions</h2>
                <button class="instructions-close" onclick="closeInstructions()">Close</button>
            </div>
            
            <div class="instructions-section">
                <h3>What is Looprint?</h3>
                <p>
                    Looprint is an automated multi-loop G-code builder for Bambu Lab P1/P1S, X1/X1C, A1, and A1 Mini printers. It takes your sliced G-code or 3MF file and automatically creates multiple print loops with push-off sequences between each loop, allowing you to print multiple copies of your model automatically.
                </p>
                <p id="factorianLinkInstructions">
                    <strong>Logic based on <a href="https://factoriandesigns.com/" target="_blank" rel="noopener noreferrer" style="color: var(--accent);">Factorian Designs</a> G-code templates.</strong> I recommend watching his videos: <a href="https://factoriandesigns.com/print-automation-bambu-lab-a1-a1-mini" target="_blank" rel="noopener noreferrer" style="color: var(--accent);" id="factorianLinkInstructionsAnchorA1">A1/A1 Mini</a> or <a href="https://factoriandesigns.com/print-automation-bambu-lab-p1-x1-2" target="_blank" rel="noopener noreferrer" style="color: var(--accent);" id="factorianLinkInstructionsAnchorP1X1">P1/P1S/X1/X1C</a>.
                </p>
            </div>

            <div class="instructions-section">
                <h3>Supported Printers</h3>
                <p>Looprint supports multiple Bambu Lab printer models. Click to expand details for your printer:</p>
                
                <div class="accordion-controls">
                    <button class="accordion-control-btn" onclick="expandAllAccordions()">Expand All</button>
                    <button class="accordion-control-btn" onclick="collapseAllAccordions()">Collapse All</button>
                </div>
                
                <div class="printer-accordion">
                    <div class="printer-accordion-header" onclick="toggleAccordion(this)">
                        <h4>üñ®Ô∏è P1 / P1S (CoreXY)</h4>
                        <span class="printer-accordion-icon">‚ñº</span>
                    </div>
                    <div class="printer-accordion-content">
                        <div class="printer-accordion-inner">
                            <ul>
                                <li>X-axis push (gantry moves)</li>
                                <li>Full bed sweep (7 passes, X-axis)</li>
                                <li>Dynamic multi-lane push system (Left, Center, Right)</li>
                                <li>Z offset: 30mm below model top</li>
                                <li>Start code with optional filament flush</li>
                                <li>M190 cooldown before push-off</li>
                                <li>End sound sequence</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="printer-accordion">
                    <div class="printer-accordion-header" onclick="toggleAccordion(this)">
                        <h4>üñ®Ô∏è X1 / X1C (CoreXY)</h4>
                        <span class="printer-accordion-icon">‚ñº</span>
                    </div>
                    <div class="printer-accordion-content">
                        <div class="printer-accordion-inner">
                            <ul>
                                <li>X-axis push (gantry moves) - same as P1/P1S</li>
                                <li>Full bed sweep (7 passes, X-axis)</li>
                                <li>Dynamic multi-lane push system (Left, Center, Right)</li>
                                <li>Z offset: 30mm below model top</li>
                                <li>Start code with optional filament flush</li>
                                <li>Cutter sequence (G1 Y-3) before push-off (X1-specific)</li>
                                <li>M190 cooldown before push-off</li>
                                <li>End sound sequence</li>
                                <li>Automatic printer model detection from 3MF metadata (BL-P001 or BL-P002)</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="printer-accordion">
                    <div class="printer-accordion-header" onclick="toggleAccordion(this)">
                        <h4>üñ®Ô∏è A1 (Bed Slinger)</h4>
                        <span class="printer-accordion-icon">‚ñº</span>
                    </div>
                    <div class="printer-accordion-content">
                        <div class="printer-accordion-inner">
                            <ul>
                                <li>Y-axis push (bed moves, gantry stationary)</li>
                                <li>Wiggle sweep (X: -48 to 256mm)</li>
                                <li>Automatic Y-axis push using Factorian's 41mm rule</li>
                                <li>Z offset: 40mm below model top (Factorian's rule)</li>
                                <li>Print head parked at X-48 (no clearance needed)</li>
                                <li>Automatic printer model detection from 3MF metadata (N2S)</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="printer-accordion">
                    <div class="printer-accordion-header" onclick="toggleAccordion(this)">
                        <h4>üñ®Ô∏è A1 Mini (Bed Slinger)</h4>
                        <span class="printer-accordion-icon">‚ñº</span>
                    </div>
                    <div class="printer-accordion-content">
                        <div class="printer-accordion-inner">
                            <ul>
                                <li>Y-axis push (bed moves, gantry stationary) - same as A1</li>
                                <li>Wiggle sweep (X: -13 to 180mm)</li>
                                <li>Automatic Y-axis push using Factorian's 41mm rule</li>
                                <li>Z offset: 40mm below model top (Factorian's rule)</li>
                                <li>Automatic printer model detection from 3MF metadata (N1)</li>
                                <li>‚ö†Ô∏è <strong>Requires 50mm clearance to the left of the bed (see Safety Reminders)</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="instructions-section">
                <h3>Supported File Types</h3>
                <ul>
                    <li><strong class="highlight">G-code files</strong> - Export from Bambu Studio: File ‚Üí Export ‚Üí Export G-Code
                        <ul>
                            <li>Supported extensions: <code>.gcode</code>, <code>.gco</code>, <code>.g</code>, <code>.txt</code></li>
                            <li>Must be printed from SD card (required)</li>
                            <li>Looprint automatically adds start and end code to all files. <strong>Optional:</strong> You can use <a href="https://factoriandesigns.com/" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none;">Factorian Designs</a> start and end code templates if you prefer. I recommend watching his video: <a href="https://factoriandesigns.com/print-automation-bambu-lab-a1-a1-mini" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none;">A1/A1 Mini</a> or <a href="https://factoriandesigns.com/print-automation-bambu-lab-p1-x1-2" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none;">P1/P1S/X1/X1C</a></li>
                            <li>Printer model must be selected manually (P1/P1S, X1/X1C, A1, or A1 Mini)</li>
                        </ul>
                    </li>
                    <li><strong class="highlight">3MF files</strong> - Export from Bambu Studio: Dropdown (where "Print Plate" is) ‚Üí "Export plate sliced file"
                        <ul>
                            <li>Supported extension: <code>.3mf</code></li>
                            <li>Can be sent directly to the printer from Bambu Studio</li>
                            <li>Printer model is automatically detected from 3MF metadata and locked</li>
                        </ul>
                    </li>
                </ul>
                <p>
                    Start and end code are added automatically for all file types. You don't need any special printer profiles or modifications.
                </p>
                <p>
                    <strong>Note:</strong> Maximum file size: 150MB
                </p>
            </div>

            <div class="instructions-section">
                <h3>How to Use Looprint</h3>
                <ol>
                    <li>
                        <strong>Upload your file</strong>
                        <ul>
                            <li><strong>For 3MF files:</strong>
                                <ol>
                                    <li>Slice your model in Bambu Studio</li>
                                    <li>Click the dropdown where you normally click "Print Plate"</li>
                                    <li>Select "Export plate sliced file"</li>
                                    <li>Click "Choose File" or drag and drop the exported 3MF file to Looprint</li>
                                    <li>The file will be validated automatically</li>
                                    <li>Printer model is automatically detected from 3MF metadata and locked</li>
                                    <li>After generating: Open the downloaded 3MF file in Bambu Studio and click "Print Plate" (do not slice again)</li>
                                </ol>
                            </li>
                            <li><strong>For G-code files:</strong>
                                <ol>
                                    <li>Slice your model in Bambu Studio (any G-code file works - Looprint adds start and end code automatically). <strong>Optional:</strong> You can use <a href="https://factoriandesigns.com/" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none;">Factorian Designs</a> start and end code templates if you prefer. I recommend watching his video: <a href="https://factoriandesigns.com/print-automation-bambu-lab-a1-a1-mini" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none;">A1/A1 Mini</a> or <a href="https://factoriandesigns.com/print-automation-bambu-lab-p1-x1-2" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none;">P1/P1S/X1/X1C</a></li>
                                    <li>Click "File" in the menu bar</li>
                                    <li>Select "Export" ‚Üí "Export G-Code"</li>
                                    <li>Click "Choose File" or drag and drop the exported G-code file to Looprint</li>
                                    <li>The file will be validated automatically</li>
                                    <li>Select your printer model (P1/P1S, X1/X1C, or A1) from the dropdown</li>
                                    <li>After generating: Copy the downloaded G-code file to SD card and print from SD card (required)</li>
                                </ol>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <strong>Select Printer Model</strong>
                        <ul>
                            <li><strong class="highlight">For 3MF files:</strong> Printer model is automatically detected from metadata and locked (you'll see a checkmark note)</li>
                            <li><strong class="highlight">For G-code files:</strong> Select your printer model from the dropdown:
                                <ul>
                                    <li><strong>P1/P1S/X1/X1C:</strong> Shows push direction selector (Left/Center/Right) in bed preview</li>
                                    <li><strong>P1/P1S/X1/X1C:</strong> Shows "Enable Start Line Purge" checkbox (optional filament flush in start code)</li>
                                    <li><strong>A1:</strong> Shows "Automatic Y-axis" (no manual selection needed)</li>
                                </ul>
                            </li>
                            <li>The interface adapts based on your printer selection</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Configure loops</strong>
                        <ul>
                            <li>Set the number of loops (how many times to print your model)</li>
                            <li>Maximum: 1000 loops (recommended maximum: 50 loops to avoid memory issues)</li>
                            <li><strong>Speed Mode:</strong> Select print speed for each loop
                                <ul>
                                    <li>Standard (100%): Normal print speed (default)</li>
                                    <li>Sport (124%): Faster print speed</li>
                                    <li>Ludicrous (166%): Maximum print speed</li>
                                    <li>Speed is automatically reset to 100% during push-off sequences and at the end of the print job for safety</li>
                                </ul>
                            </li>
                            <li><strong>P1/P1S/X1/X1C:</strong> The program automatically detects your model's placement (Left, Center, or Right)</li>
                            <li><strong>A1:</strong> The program automatically calculates Y-axis push position using Factorian's 41mm rule</li>
                            <li>You can view the detected placement in the bed preview below</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Advanced settings (optional)</strong>
                        <ul>
                            <li>Click the checkbox "‚öôÔ∏è Show Advanced Settings" to access push-off configuration</li>
                            <li><strong>Target Bed Temp:</strong> Temperature to cool the bed to before push-off starts
                                <ul>
                                    <li>Default: 18¬∞C (Approx. 23¬∞C on the plate)</li>
                                    <li>Range: 15¬∞C - 90¬∞C</li>
                                    <li>Wait max 60 min for bed to cool before push-off sequence begins</li>
                                    <li>Warning shown if set above 35¬∞C (increases risk of sticking)</li>
                                </ul>
                            </li>
                            <li><strong>Z Push Offset:</strong> How far below the model top to push
                                <ul>
                                    <li>Default: 30mm (P1/P1S/X1/X1C) / 40mm (A1 - Factorian's rule)</li>
                                    <li>Range: 5mm - 120mm</li>
                                    <li><strong>A1:</strong> Uses Factorian's 41mm rule for automatic calculation</li>
                                </ul>
                            </li>
                            <li><strong>Push Lane Offset (P1/P1S/X1/X1C only):</strong> Distance from model center for left/right push lanes
                                <ul>
                                    <li>Default: 30mm</li>
                                    <li>Range: 10mm - 60mm</li>
                                    <li>Automatically adjusted if too large for model placement (prevents crashes)</li>
                                    <li>Maximum possible offset is shown when auto-adjusted</li>
                                    <li><strong>Not applicable for A1</strong> (uses automatic Y-axis push)</li>
                                </ul>
                            </li>
                            <li><strong>Push Direction (P1/P1S/X1/X1C only):</strong> Can be changed manually in advanced mode
                                <ul>
                                    <li>Click zones in the bed preview to change direction</li>
                                    <li>Warning shown if manually changed from auto-detected direction</li>
                                    <li><strong>A1:</strong> Automatic Y-axis push (no manual selection)</li>
                                </ul>
                            </li>
                            <li><strong>Enable Start Line Purge (P1/P1S/X1/X1C):</strong> Optional filament flush in start code
                                <ul>
                                    <li>Default: Enabled (uses start code with flush - matches Factorian's P1 template)</li>
                                    <li>When disabled: Uses start code without filament flush sequence (faster start)</li>
                                    <li>Useful when switching materials or after pause. Disable for faster start when using same filament.</li>
                                </ul>
                            </li>
                            <li><strong>Push-off Speed:</strong> Speed of the push-off motion
                                <ul>
                                    <li>Default: 300 mm/min</li>
                                    <li>Range: 100 - 1000 mm/min</li>
                                    <li>Lower = slower, safer for delicate prints</li>
                                </ul>
                            </li>
                            <li><strong>Full Bed Sweep / Wiggle Sweep (optional):</strong> Clears debris after push-off
                                <ul>
                                    <li><strong>P1/P1S/X1/X1C:</strong> Full bed sweep - 7 passes in safe one-way back-to-front pattern (X-axis)</li>
                                    <li><strong>A1:</strong> Wiggle sweep - X-axis wiggle from -48mm to 256mm</li>
                                    <li>Sweep Speed: Default 300 mm/min (range: 100-1000 mm/min)</li>
                                    <li>Sweep Z Height: Default 1mm (bed level, range: 0.5-50mm)</li>
                                    <li>Always runs with automatic spacing</li>
                                    <li>Respects safe bed boundaries to avoid collisions</li>
                                    <li>Can be tested separately with "Generate Sweep Test File" button (appears when enabled)</li>
                                    <li><strong class="highlight">A1 Mini Warning:</strong> Requires 50mm clearance to the left of the bed (see Safety Reminders section)</li>
                                </ul>
                            </li>
                            <li><strong>Enable Negative Z Push-Off (A1 only - advanced):</strong> Optional feature for low-height models
                                <ul>
                                    <li>Only available for A1 (not A1 Mini, P1, X1)</li>
                                    <li>Uses negative Z values (Z-17) when nozzle head is at X-48 (far left)</li>
                                    <li>Adds an additional push-off sequence after standard push-off</li>
                                    <li><strong class="highlight">‚ö†Ô∏è WARNING:</strong> Only use if you do NOT have a Z-axis stiffener mod installed</li>
                                    <li>Based on Factorian Designs custom end code logic</li>
                                    <li>Should only be used when standard push-off is insufficient for very low parts</li>
                                    <li>Use with caution - this is an advanced feature</li>
                                </ul>
                            </li>
                            <li><strong class="highlight">Safety confirmation:</strong> Checkbox to confirm your model was sliced with Brim enabled. Brim replaces the standard purge line behavior, ensuring a clean and consistent first layer.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Generate and download</strong>
                        <ul>
                            <li>Click "Generate Loop File" to create the looped file</li>
                            <li>Or click "Generate Test File" (appears after file upload) to test just the push-off sequence</li>
                            <li>Or click "Generate Sweep Test File" (appears when Full Bed Sweep is enabled) to test just the sweep sequence</li>
                            <li>Wait for processing to complete (progress bar shows status)</li>
                            <li>Download your looped file</li>
                            <li>Use "Reset to Defaults" button to reset all settings to defaults</li>
                        </ul>
                    </li>
                </ol>
            </div>

            <div class="instructions-section">
                <h3>What Looprint Does</h3>
                <p>When you generate a looped file, Looprint:</p>
                <ol>
                    <li><strong>Detects printer model</strong> - Automatically from 3MF metadata or manual selection for G-code</li>
                    <li><strong>Analyzes your file</strong> - Detects model placement, dimensions, and print settings</li>
                    <li><strong>Removes original start/end code</strong> - Cleans up the slicer's start and end code</li>
                    <li><strong>Adds custom start code</strong> - Inserts optimized printer-specific start code with proper temperature settings</li>
                    <li><strong>Loops the print</strong> - Repeats your print G-code for the specified number of loops</li>
                    <li><strong>Adds push-off sequences</strong> - Inserts automated push-off code between each loop:
                        <ul>
                            <li><strong>P1/P1S/X1/X1C:</strong> X-axis push with dynamic multi-lane system (Left, Center, Right)</li>
                            <li><strong>X1/X1C:</strong> Includes cutter sequence (G1 Y-3) before push-off</li>
                            <li><strong>A1:</strong> Y-axis push using Factorian's 41mm rule (automatic calculation)</li>
                        </ul>
                    </li>
                    <li><strong>Adds bed sweep (optional)</strong> - If enabled, clears debris after push-off:
                        <ul>
                            <li><strong>P1/P1S/X1/X1C:</strong> Full bed sweep (7 passes, X-axis)</li>
                            <li><strong>A1:</strong> Wiggle sweep (X: -48 to 256mm)</li>
                        </ul>
                    </li>
                    <li><strong>Adds custom end code</strong> - Inserts printer-specific end code that cools the bed and prepares for the next loop
                        <ul>
                            <li><strong>P1/P1S:</strong> Includes M190 cooldown, dynamic push, and end sound</li>
                            <li><strong>X1/X1C:</strong> Includes M190 cooldown, cutter sequence, dynamic push, and end sound</li>
                        </ul>
                    </li>
                    <li><strong>Preserves all settings</strong> - All temperatures, speeds, and other settings from your original file are maintained (Speed Mode overrides print speed during loops)</li>
                    <li><strong>Resets speed for safety</strong> - Automatically resets print speed to 100% during push-off sequences and at the end of the entire print job</li>
                    <li><strong>Adds metadata watermark (G-code only)</strong> - Includes Looprint signature with GitHub link in G-code comments (not printed on the model)</li>
                </ol>
            </div>

            <div class="instructions-section">
                <h3>Printer-Specific Push Systems</h3>
                <p>Click to expand technical details for your printer model:</p>
                
                <div class="printer-accordion">
                    <div class="printer-accordion-header" onclick="toggleAccordion(this)">
                        <h4>‚öôÔ∏è P1 / P1S / X1 / X1C: Dynamic Multi-Lane Push System</h4>
                        <span class="printer-accordion-icon">‚ñº</span>
                    </div>
                    <div class="printer-accordion-content">
                        <div class="printer-accordion-inner">
                            <p>
                                Looprint uses a dynamic push-off system that calculates three push lanes based on your model's position:
                            </p>
                            <ul>
                                <li><strong>Center lane:</strong> Pushes at the model's center (X = (minX + maxX) / 2)</li>
                                <li><strong>Left lane:</strong> Pushes at center - offset (default: 30mm to the left of center)</li>
                                <li><strong>Right lane:</strong> Pushes at center + offset (default: 30mm to the right of center)</li>
                            </ul>
                            <p>
                                This ensures stable ejection regardless of your model's shape. The offset is automatically adjusted if it would cause the printer to crash into the bed edges. A warning is displayed if auto-adjustment occurs, showing the maximum possible offset.
                            </p>
                            <p>
                                <strong>Safety Clear:</strong> After push-off, the hotend moves to a safe X position to avoid hitting the model on the next loop.
                            </p>
                            <p style="margin-top: 12px;">
                                <strong>X1/X1C Specific:</strong> Includes cutter sequence (`G1 Y-3`) before push-off. See "Supported Printers" section above for complete feature list.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="printer-accordion">
                    <div class="printer-accordion-header" onclick="toggleAccordion(this)">
                        <h4>‚öôÔ∏è A1: Automatic Y-Axis Push System</h4>
                        <span class="printer-accordion-icon">‚ñº</span>
                    </div>
                    <div class="printer-accordion-content">
                        <div class="printer-accordion-inner">
                            <p>
                                A1 uses a bed slinger design where the bed moves (Y-axis) and the gantry stays stationary. Looprint automatically calculates the optimal push position using Factorian's 41mm rule:
                            </p>
                            <ul>
                                <li><strong>Automatic Y-axis push:</strong> Model center Y is calculated from G-code coordinates</li>
                                <li><strong>Factorian's 41mm rule:</strong> Z offset automatically set to 40mm below model top</li>
                                <li><strong>No manual selection:</strong> Push direction is fully automatic</li>
                                <li><strong>Wiggle sweep:</strong> X-axis wiggle from -48mm to 256mm to clear debris</li>
                                <li><strong>Negative Z Push-Off (advanced, optional):</strong> Available in Advanced Settings for very low-height models. See Advanced Settings section for details and warnings.</li>
                            </ul>
                            <p>
                                <strong>‚ö†Ô∏è Important:</strong> A1 Mini only: Wiggle sweep requires 50mm clearance to the left of the bed. See "Important Safety Reminders" section for details.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="instructions-section" style="background: var(--input); padding: 20px; border-radius: 10px; border-left: 4px solid var(--accent);">
                <h3 style="margin-top: 0;">‚ö†Ô∏è Important Safety Reminders</h3>
                <ul style="margin-bottom: 0;">
                    <li><strong>Beta Notice:</strong> Looprint is still in beta. Do not leave your printer unattended ‚Äî always stay nearby and monitor the process during automated looping.</li>
                    <li><strong>Use Brim</strong> - Your model must be sliced with Brim enabled. This replaces the standard purge line behavior, ensuring a clean and consistent first layer.</li>
                    <li><strong>Place model at edge</strong> - Position your model at the edge of the bed for proper ejection</li>
                    <li><strong class="highlight">G-code files:</strong> Must be printed from SD card (required)</li>
                    <li><strong class="highlight">3MF files:</strong> After generating, open the downloaded 3MF file in Bambu Studio and click "Print Plate" (do not slice again)</li>
                    <li><strong>Monitor first print</strong> - Watch the first loop to ensure everything works as expected</li>
                    <li><strong>A1 Mini users:</strong> Ensure 50mm clearance to the left of the bed for wiggle sweep (A1 print head is parked further left, no clearance needed)</li>
                    <li><strong>P1/P1S/X1/X1C users:</strong> Ensure model placement allows for dynamic push lanes (Left, Center, Right)</li>
                </ul>
            </div>

            <div class="instructions-section">
                <h3>Tips & Best Practices</h3>
                <ul>
                    <li>Start with 2-3 loops to test before doing longer runs</li>
                    <li>Use "Generate Test File" to test push-off sequence only</li>
                    <li>Use "Generate Sweep Test File" (when Full Bed Sweep is enabled) to test sweep sequence only</li>
                    <li>Full Bed Sweep is useful for clearing debris between loops, especially with multiple prints</li>
                    <li>Keep your bed clean and properly leveled</li>
                    <li>Ensure your model has a good first layer adhesion</li>
                    <li>The cooldown temperature (default 18¬∞C) helps the finished print release from the bed so it can be pushed off</li>
                    <li>If prints stick and won't release, try lowering the cooldown temperature slightly</li>
                    <li>If prints release too easily or don't stick enough during printing, you may need to adjust the cooldown temperature</li>
                </ul>
            </div>

            <div class="instructions-section">
                <h3>Troubleshooting</h3>
                <p>Having issues? Click to expand troubleshooting for your printer model:</p>
                
                <div class="printer-accordion">
                    <div class="printer-accordion-header" onclick="toggleAccordion(this)">
                        <h4>üîß General Issues</h4>
                        <span class="printer-accordion-icon">‚ñº</span>
                    </div>
                    <div class="printer-accordion-content">
                        <div class="printer-accordion-inner">
                            <ul>
                                <li><strong>File won't upload:</strong> Ensure it's a valid G-code (.gcode, .gco, .g, .txt) or 3MF (.3mf) file. Maximum file size: 150MB. Looprint automatically adds start and end code to all files. <strong>Optional:</strong> You can use <a href="https://factoriandesigns.com/" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none;">Factorian Designs</a> start and end code templates. See: <a href="https://factoriandesigns.com/print-automation-bambu-lab-a1-a1-mini" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none;">A1/A1 Mini</a> or <a href="https://factoriandesigns.com/print-automation-bambu-lab-p1-x1-2" target="_blank" rel="noopener noreferrer" style="color: var(--accent); text-decoration: none;">P1/P1S/X1/X1C</a></li>
                                <li><strong>Push-off doesn't work:</strong> Verify Brim is enabled and model is at bed edge. Use "Generate Test File" to test push-off sequence</li>
                                <li><strong>Temperature issues:</strong> All temperatures come from your original file - check your slicer settings. Start code automatically extracts and uses correct temperatures</li>
                                <li><strong>File too large:</strong> Maximum file size is 150MB. Large files may take longer to process - be patient. Progress bar shows processing status</li>
                                <li><strong>Too many loops warning:</strong> If you set more than 100 loops, you'll get a warning. Recommended maximum is 50 loops</li>
                                <li><strong>Cooldown temperature warning:</strong> If set above 35¬∞C, you'll see a warning about increased sticking risk</li>
                                <li><strong>Settings not saving:</strong> Settings are saved to browser localStorage. Clear browser data if you have issues</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="printer-accordion">
                    <div class="printer-accordion-header" onclick="toggleAccordion(this)">
                        <h4>üîß P1 / P1S / X1 / X1C Issues</h4>
                        <span class="printer-accordion-icon">‚ñº</span>
                    </div>
                    <div class="printer-accordion-content">
                        <div class="printer-accordion-inner">
                            <ul>
                                <li><strong>Wrong placement detected:</strong> Check that your model is clearly on one side of the bed. You can manually change push direction in advanced settings if needed</li>
                                <li><strong>Push lane offset auto-adjusted:</strong> If you see a warning about offset being adjusted, the value was too large for your model placement. Check the displayed maximum value</li>
                                <li><strong>X1/X1C - Cutter sequence not working:</strong> Verify end code includes `G1 Y-3` before push-off. Check that M190 cooldown completes before cutter sequence. Use "Generate Test File" to debug</li>
                                <li><strong>X1/X1C - Start code flush option:</strong> "Start Line Purge" checkbox controls filament flush in start code. Default: Enabled (matches Factorian's P1 template). Disable for faster start when using same filament.</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="printer-accordion">
                    <div class="printer-accordion-header" onclick="toggleAccordion(this)">
                        <h4>üîß A1 Issues</h4>
                        <span class="printer-accordion-icon">‚ñº</span>
                    </div>
                    <div class="printer-accordion-content">
                        <div class="printer-accordion-inner">
                            <ul>
                                <li><strong>Wiggle sweep collision warning:</strong> Ensure 50mm clearance to the left of the bed. Check model placement in bed preview</li>
                                <li><strong>Y-axis push not working:</strong> Verify model center Y is correctly calculated. Check that first_layer_center_no_wipe_tower is extracted correctly. Use "Generate Test File" to debug</li>
                                <li><strong>Temperature offset:</strong> A1 automatically applies -4¬∞C temperature offset</li>
                                <li><strong>Negative Z Push-Off:</strong> Only available for A1 (not A1 Mini). See Advanced Settings section for details and warnings.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="instructions-section">
                <h3>Need Help?</h3>
                <p>
                    If you encounter issues or have questions, make sure you've watched the Factorian Designs videos about the automation system that Looprint is based on: <a href="https://factoriandesigns.com/print-automation-bambu-lab-a1-a1-mini" target="_blank" rel="noopener noreferrer" style="color: var(--accent);" id="factorianLinkHelpAnchorA1">A1/A1 Mini</a> or <a href="https://factoriandesigns.com/print-automation-bambu-lab-p1-x1-2" target="_blank" rel="noopener noreferrer" style="color: var(--accent);" id="factorianLinkHelpAnchorP1X1">P1/P1S/X1/X1C</a>.
                </p>
            </div>
    </div>
</div>

<script src="app.js"></script>
<script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</body>
</html>
